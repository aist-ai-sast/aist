<div class="aist-pipeline-scope" data-aist-scope="{{ scope|default:'start' }}">
    {% if scope == "launch-config" %}
        {# In launch-config modal, outer page already provides <form> #}
        {{ form.selection_signature }}
    {% else %}
        <form method="post">
        {% csrf_token %}
        {{ form.selection_signature }}
    {% endif %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        {# LaunchConfig metadata fields (present only in AISTLaunchConfigForm) #}
        {% if form.name %}
            <div class="mb-3 row">
                <label class="col-sm-3 col-form-label">{{ form.name.label }}</label>
                <div class="col-sm-9">
                    {{ form.name }}
                </div>
            </div>

            <div class="mb-3 row">
                <label class="col-sm-3 col-form-label">{{ form.description.label }}</label>
                <div class="col-sm-9">
                    {{ form.description }}
                </div>
            </div>

            <div class="mb-3 row">
                <label class="col-sm-3 col-form-label">{{ form.is_default.label }}</label>
                <div class="col-sm-9">
                    <div class="form-check">
                        {{ form.is_default }}
                    </div>
                </div>
            </div>

            <hr class="my-3"/>
        {% endif %}


        {% if form.project %}
            {# Project select #}
            <div class="mb-3 row">
                <label class="col-sm-3 col-form-label">{{ form.project.label }}</label>
                <div class="col-sm-9">
                    {{ form.project }}
                    {% if form.project.help_text %}
                        <small class="form-text text-muted small">{{ form.project.help_text }}</small>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {# Project version + create button #}
        <div class="mb-3 row align-items-start">
            <label class="col-sm-3 col-form-label">{{ form.project_version.label }}</label>
            <div class="col-sm-9 d-flex gap-2">
                <div class="flex-grow-1">
                    {{ form.project_version }}
                </div>
                <button type="button"
                        class="btn btn-outline-primary"
                        id="btn-open-create-version"
                        title="Create version for selected project"
                        disabled>
                    Create version
                </button>
            </div>
        </div>

        <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">{{ form.ai_mode.label }}</label>
            <div class="col-sm-9">
                {% for radio in form.ai_mode %}
                    <div class="form-check">
                        {{ radio.tag }}
                        <label class="form-check-label"
                               for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                    </div>
                {% endfor %}
            </div>
        </div>

        <style>
            .aist-ai-filter-block { display: none; }
            .aist-pipeline-scope:has(input[name$="ai_mode"][value="AUTO_DEFAULT"]:checked) .aist-ai-filter-block {
                display: flex;
            }
            .aist-pipeline-scope:has(input[name$="ai_mode"][value="AUTO_DEFAULT"]:checked) .aist-ai-filter-reference {
                display: block;
            }
        </style>

        <div class="mb-3 row aist-ai-filter-block"
             {% if form.ai_mode.value != "AUTO_DEFAULT" %}style="display:none;"{% endif %}>
            <label class="col-sm-3 col-form-label">AI filter (JSON)</label>
            <div class="col-sm-9">
                {{ form.ai_filter_json }}
                {% if form.ai_filter_json.errors %}
                    <div class="text-danger small mt-1">
                        {% for err in form.ai_filter_json.errors %}
                            <div>{{ err }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
                <div class="small mt-1" id="aist-ai-filter-validation"></div>
                <p class="form-text text-muted small mt-1">
                    Used only when AI mode is AUTO_DEFAULT. Example:
                    <code>{"limit": 50, "severity": [{"comparison": "EQUALS", "value": "High"}]}</code>
                    <a class="ms-2" href="{% url "dojo_aist:ai_filter_help" %}" target="_blank" rel="noopener">
                        Help
                    </a>
                </p>
                <details class="mt-2 aist-ai-filter-reference"
                         {% if form.ai_mode.value != "AUTO_DEFAULT" %}style="display:none;"{% endif %}>
                    <summary class="text-muted small">AI filter reference</summary>
                    <div class="mt-2">
                        {% if ai_filter_reference %}
                            <div class="small text-muted mb-1">Comparisons</div>
                            <div class="d-flex flex-wrap gap-1 mb-2">
                                {% for cmp in ai_filter_reference.comparisons %}
                                    <span class="badge bg-secondary">{{ cmp }}</span>
                                {% endfor %}
                            </div>

                            <div class="small text-muted mb-1">Fields</div>
                            <div class="table-responsive">
                                <table class="table table-sm align-middle mb-0">
                                    <thead>
                                    <tr class="text-muted small">
                                        <th style="width: 22%">Field</th>
                                        <th style="width: 12%">Type</th>
                                        <th style="width: 46%">Allowed comparisons</th>
                                        <th style="width: 20%">Notes</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for f in ai_filter_reference.fields %}
                                        <tr>
                                            <td class="font-monospace">{{ f.name }}</td>
                                            <td>{{ f.type }}</td>
                                            <td class="small">
                                                {% if f.allowed_comparisons %}
                                                    {{ f.allowed_comparisons|join:", " }}
                                                {% else %}
                                                    <span class="text-muted">—</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-muted small">
                                                {% if not f.allow_regex %}No REGEX{% endif %}
                                                {% if not f.allow_contains %}
                                                    {% if not f.allow_regex %} · {% endif %}No CONTAINS
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-muted small">Reference unavailable.</div>
                        {% endif %}
                    </div>
                </details>
            </div>
        </div>

        <script>
            (function () {
                var textarea = document.getElementById("id_ai_filter_json");
                var validation = document.getElementById("aist-ai-filter-validation");
                var aiModeInputs = document.querySelectorAll('input[name$="ai_mode"]');
                if (!textarea || !validation || !aiModeInputs.length) {
                    return;
                }

                var debounceTimer = null;

                function getCookie(name) {
                    var value = "; " + document.cookie;
                    var parts = value.split("; " + name + "=");
                    if (parts.length === 2) {
                        return parts.pop().split(";").shift();
                    }
                    return "";
                }

                function getCsrfToken() {
                    var fromCookie = getCookie("csrftoken");
                    if (fromCookie) {
                        return fromCookie;
                    }
                    var input = document.querySelector('input[name="csrfmiddlewaretoken"]');
                    return input ? input.value : "";
                }

                function isAutoDefault() {
                    var checked = document.querySelector('input[name$="ai_mode"]:checked');
                    return checked && checked.value === "AUTO_DEFAULT";
                }

                function setStatus(ok, message) {
                    if (!message) {
                        validation.textContent = "";
                        validation.className = "small mt-1";
                        return;
                    }
                    validation.textContent = message;
                    validation.className = ok ? "small mt-1 text-success" : "small mt-1 text-danger";
                }

                function validateFilter() {
                    if (!isAutoDefault()) {
                        setStatus(true, "");
                        return;
                    }

                    var raw = (textarea.value || "").trim();
                    if (!raw) {
                        setStatus(true, "");
                        return;
                    }

                    fetch("{% url 'dojo_aist:ai_filter_validate' %}", {
                        method: "POST",
                        credentials: "same-origin",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCsrfToken(),
                        },
                        body: JSON.stringify({raw: raw}),
                    }).then(function (resp) {
                        var contentType = resp.headers.get("content-type") || "";
                        if (contentType.indexOf("application/json") !== -1) {
                            return resp.json().then(function (data) {
                                return {ok: resp.ok, status: resp.status, data: data};
                            });
                        }
                        return {ok: resp.ok, status: resp.status, data: null};
                    }).then(function (result) {
                        if (result.ok && result.data && result.data.ok) {
                            setStatus(true, "Filter is valid.");
                        } else {
                            var msg = (result.data && result.data.error) || ("AI filter is invalid. HTTP " + result.status);
                            setStatus(false, msg);
                        }
                    }).catch(function () {
                        setStatus(false, "Unable to validate AI filter right now.");
                    });
                }

                function debouncedValidate() {
                    if (debounceTimer) {
                        clearTimeout(debounceTimer);
                    }
                    debounceTimer = setTimeout(validateFilter, 400);
                }

                textarea.addEventListener("input", debouncedValidate);
                aiModeInputs.forEach(function (input) {
                    input.addEventListener("change", debouncedValidate);
                });
            })();
        </script>

        <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">{{ form.rebuild_images.label }}</label>
            <div class="col-sm-9">
                <div class="form-check">
                    {{ form.rebuild_images }}
                </div>
            </div>
        </div>

        {# Log level #}
        <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">{{ form.log_level.label }}</label>
            <div class="col-sm-9">
                {{ form.log_level }}
            </div>
        </div>

        {# Languages as checkboxes #}
        <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">{{ form.languages.label }}</label>
            <div class="col-sm-9" id="languages-group">
                <div class="row">
                    {% for checkbox in form.languages %}
                        <div class="col-sm-6 col-lg-4">
                            <div class="form-check mb-2">
                                {{ checkbox.tag }}
                                <label class="form-check-label">{{ checkbox.choice_label }}</label>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <small class="form-text text-muted small mt-1">
                    Project-required languages are preselected and disabled.
                </small>
            </div>
        </div>

        {# Analyzers as checkboxes #}
        <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">{{ form.analyzers.label }}</label>
            <div class="col-sm-9">
                <div class="row">
                    {% for checkbox in form.analyzers %}
                        <div class="col-sm-6 col-lg-4">
                            <div class="form-check mb-2">
                                {{ checkbox.tag }}
                                <label class="form-check-label">{{ checkbox.choice_label }}</label>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {# Time class #}
        <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">{{ form.time_class_level.label }}</label>
            <div class="col-sm-9">
                {{ form.time_class_level }}
            </div>
        </div>

        <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">Actions</label>
            <div class="col-sm-9">
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <button type="button" class="btn btn-outline-secondary" id="btn-open-create-action" disabled>
                        Add action
                    </button>
                    {% if form.project %}
                        <small class="text-muted" id="aist-action-hint">Actions will run once for this pipeline.</small>
                    {% else %}
                        <small class="text-muted" id="aist-action-hint">Save preset to enable actions.</small>
                    {% endif %}
                </div>
                {% if scope == "start" %}
                    <input type="hidden" name="one_off_actions" id="aist-one-off-actions" value="[]">
                    <div id="aist-one-off-actions-list" class="mt-2"></div>
                {% else %}
                    <div id="aist-preset-status" class="text-muted small mt-2">Not saved yet.</div>
                    <div id="aist-actions-empty" class="text-muted small mt-2">No actions yet. Save preset to enable.</div>
                    <div id="aist-actions-list" class="mt-2"></div>
                {% endif %}
            </div>
        </div>

        {% if form.project %}
            <div class="text-end mt-3">
                <button type="submit" class="btn btn-primary" id="btn-start" disabled>Start pipeline</button>
            </div>
        {% else %}
            <div class="text-end mt-3">
                <button type="submit" class="btn btn-primary" id="btn-save-launch-config">Save preset</button>
            </div>
        {% endif %}
    {% if scope != "launch-config" %}
        </form>
    {% endif %}
</div>
