<script>
    (function () {
        "use strict";

        /* run once */
        if (window.__AIST_BOOTED__) return;
        window.__AIST_BOOTED__ = true;

        /* helpers */
        function getCookie(name) {
            var value = "; " + document.cookie;
            var parts = value.split("; " + name + "=");
            if (parts.length === 2) return decodeURIComponent(parts.pop().split(";").shift());
            return null;
        }

        function getCSRFToken(form) {
            // 1) Prefer cookie (Django default: csrftoken)
            var fromCookie = getCookie("csrftoken");
            if (fromCookie) return fromCookie;

            // 2) Fallback: hidden input rendered by {% csrf_token %}
            var el = form ? form.querySelector('input[name="csrfmiddlewaretoken"]') : null;
            return el ? (el.value || "") : "";
        }

        function normalizeVersions(raw) {
            if (!raw) return [];
            if (Object.prototype.toString.call(raw) === "[object Array]") {
                var out = [];
                for (var i = 0; i < raw.length; i++) {
                    var v = raw[i];
                    if (v && typeof v === "object") {
                        var id = (v.id != null ? String(v.id) : (v.value != null ? String(v.value) : (v.slug != null ? String(v.slug) : String(v))));
                        var lbl = (v.label != null ? String(v.label) : (v.name != null ? String(v.name) : (v.id != null ? String(v.id) : String(v))));
                        out.push({id: id, label: lbl});
                    } else {
                        out.push({id: String(v), label: String(v)});
                    }
                }
                return out;
            }
            if (typeof raw === "object") {
                var out2 = [];
                for (var k in raw) if (Object.prototype.hasOwnProperty.call(raw, k)) {
                    var vv = raw[k];
                    if (vv && typeof vv === "object") out2.push({
                        id: String(vv.id != null ? vv.id : k),
                        label: String(vv.label != null ? vv.label : (vv.name != null ? vv.name : k))
                    });
                    else out2.push({id: String(k), label: String(vv)});
                }
                return out2;
            }
            return [{id: String(raw), label: String(raw)}];
        }

        function prettifyLabel(label, projectId) {
            var pid = String(projectId || "");
            var s = String(label || "");
            var prefix = pid + ":";
            if (pid && s.indexOf(prefix) === 0) return s.slice(prefix.length);
            return s;
        }

        function hasSelectpicker() {
            return !!(window.jQuery && window.jQuery.fn && window.jQuery.fn.selectpicker);
        }

        function isSelectpickerApplied(el) {
            if (!hasSelectpicker() || !el) return false;
            var $ = window.jQuery;
            return !!($(el).data("selectpicker")) || ($(el).parent().hasClass("bootstrap-select"));
        }

        /* main */
        function main() {
            var scopeRoot =
                document.querySelector('.aist-pipeline-scope[data-aist-scope="launch-config"]') ||
                document.querySelector(".aist-pipeline-scope");

            if (!scopeRoot) return;

            var form = scopeRoot.querySelector('form') ||
                scopeRoot.querySelector('form[method="post"]') ||
                scopeRoot.closest('form');

            if (!form) return;

            var scopeKind = scopeRoot.getAttribute("data-aist-scope") || "start";

            function qsNameEnds(root, selector, suffix) {
                // selector пример: 'select', 'input[type="checkbox"]', 'input[type="radio"]'
                return root.querySelector(selector + '[name$="' + suffix + '"]');
            }

            function qsaNameEnds(root, selector, suffix) {
                return root.querySelectorAll(selector + '[name$="' + suffix + '"]');
            }

            var selProject = qsNameEnds(form, 'select', 'project');
            var aiFilterBlock = scopeRoot.querySelector(".aist-ai-filter-block");
            var aiFilterReference = scopeRoot.querySelector(".aist-ai-filter-reference");
            var aiModeRadios = qsaNameEnds(form, 'input[type="radio"]', 'ai_mode');

            function getFixedProjectId() {
                // do NOT cache: projects.html sets this attribute right before opening the modal
                return (scopeRoot.getAttribute("data-aist-project-id") || "");
            }

            function getFixedLaunchConfigId() {
                return (scopeRoot.getAttribute("data-aist-launch-config-id") || "");
            }

            function getProjectId() {
                // Prefer explicit selector (Start UI), otherwise fixed project from edit modal (LaunchConfig UI)
                if (selProject) return String(getSelectValue(selProject) || "");
                return String(getFixedProjectId() || "");
            }

            function updateAiFilterVisibility() {
                if (!aiFilterBlock) return;
                var autoSelected = false;
                for (var i = 0; i < aiModeRadios.length; i++) {
                    if (aiModeRadios[i].checked && aiModeRadios[i].value === "AUTO_DEFAULT") {
                        autoSelected = true;
                        break;
                    }
                }
                aiFilterBlock.style.display = autoSelected ? "flex" : "none";
                if (aiFilterReference) {
                    aiFilterReference.style.display = autoSelected ? "block" : "none";
                }
            }

            var actionModal = document.getElementById("modalCreateLaunchAction");
            var actionError = document.getElementById("launchActionError");
            var actionTrigger = document.getElementById("action-trigger-status");
            var actionType = document.getElementById("action-type");
            var actionTitle = document.getElementById("action-title");
            var actionDescription = document.getElementById("action-description");
            var actionIncludeAiCsv = document.getElementById("action-include-ai-csv");
            var actionSlackFields = document.getElementById("action-slack-fields");
            var actionSlackChannels = document.getElementById("action-slack-channels");
            var actionSlackToken = document.getElementById("action-slack-token");
            var actionEmailFields = document.getElementById("action-email-fields");
            var actionEmails = document.getElementById("action-emails");
            var actionLogFields = document.getElementById("action-log-fields");
            var actionLogLevel = document.getElementById("action-log-level");
            var btnOpenAction = document.getElementById("btn-open-create-action");
            var btnSaveAction = document.getElementById("btn-save-launch-action");
            var actionHint = document.getElementById("aist-action-hint");
            var oneOffActionsInput = document.getElementById("aist-one-off-actions");
            var oneOffActionsList = document.getElementById("aist-one-off-actions-list");
            var oneOffActions = [];
            var launchActionsList = document.getElementById("aist-actions-list");
            var launchActionsEmpty = document.getElementById("aist-actions-empty");
            var launchActions = [];
            var actionParentModal = scopeRoot.closest ? scopeRoot.closest(".modal") : null;
            var actionParentScrollContainer = null;
            var actionParentScrollTop = 0;

            if (actionParentModal) {
                if (actionParentModal.querySelector(".modal-dialog-scrollable")) {
                    actionParentScrollContainer = actionParentModal.querySelector(".modal-body") || actionParentModal;
                } else {
                    actionParentScrollContainer = actionParentModal;
                }
            }

            function captureActionParentScroll() {
                if (actionParentScrollContainer) {
                    actionParentScrollTop = actionParentScrollContainer.scrollTop || 0;
                }
            }

            function restoreActionParentScroll() {
                if (!actionParentScrollContainer) return;
                actionParentScrollContainer.style.overflowY = "auto";
                actionParentScrollContainer.scrollTop = actionParentScrollTop || 0;
            }
            var actionHint = document.getElementById("aist-action-hint");

            function normalizeList(raw) {
                if (!raw) return [];
                return String(raw)
                    .split(",")
                    .map(function (v) { return v.trim(); })
                    .filter(function (v) { return !!v; });
            }

            function updateActionButtonState() {
                if (!btnOpenAction) return;
                if (scopeKind === "start") {
                    btnOpenAction.disabled = !getProjectId();
                    if (actionHint) {
                        actionHint.textContent = getProjectId()
                            ? "Actions will run once for this pipeline."
                            : "Select a project to add actions.";
                    }
                    return;
                }
                var cfgId = getFixedLaunchConfigId();
                btnOpenAction.disabled = !cfgId;
                if (actionHint) {
                    actionHint.textContent = cfgId
                        ? "Actions will be attached to this preset."
                        : "Save preset to enable actions.";
                }
                if (launchActionsEmpty) {
                    launchActionsEmpty.textContent = cfgId
                        ? "No actions yet."
                        : "No actions yet. Save preset to enable.";
                }
            }

            function persistOneOffActions() {
                if (!oneOffActionsInput) return;
                oneOffActionsInput.value = JSON.stringify(oneOffActions || []);
            }

            function renderOneOffActions() {
                if (!oneOffActionsList) return;
                if (!oneOffActions || oneOffActions.length === 0) {
                    oneOffActionsList.innerHTML = "";
                    return;
                }
                var html = '<div class="small text-muted mb-1">One-off actions for this run</div>';
                html += '<div class="list-group">';
                oneOffActions.forEach(function (a) {
                    var label = (a.trigger_status || "") + " → " + (a.action_type || "");
                    var detail = "";
                    if (a.action_type === "PUSH_TO_SLACK") {
                        detail = (a.config && a.config.channels) ? ("Channels: " + a.config.channels.join(", ")) : "";
                    } else if (a.action_type === "SEND_EMAIL") {
                        detail = (a.config && a.config.emails) ? ("Emails: " + a.config.emails.join(", ")) : "";
                    } else if (a.action_type === "WRITE_LOG") {
                        detail = (a.config && a.config.level) ? ("Level: " + a.config.level) : "";
                    }
                    if (a.config && a.config.include_ai_csv) {
                        detail = detail ? (detail + " · AI CSV") : "AI CSV";
                    }
                    html += '<div class="list-group-item d-flex align-items-center justify-content-between">';
                    html += '<div>';
                    html += '<div class="fw-semibold">' + label + '</div>';
                    if (detail) html += '<div class="text-muted small">' + detail + '</div>';
                    html += '</div>';
                    html += '<button type="button" class="btn btn-sm btn-outline-danger aist-remove-action" data-id="' + a.id + '">Remove</button>';
                    html += '</div>';
                });
                html += "</div>";
                oneOffActionsList.innerHTML = html;

                var removeBtns = oneOffActionsList.querySelectorAll(".aist-remove-action");
                for (var i = 0; i < removeBtns.length; i++) {
                    removeBtns[i].addEventListener("click", function (ev) {
                        var id = ev.currentTarget.getAttribute("data-id");
                        oneOffActions = (oneOffActions || []).filter(function (x) {
                            return String(x.id) !== String(id);
                        });
                        persistOneOffActions();
                        renderOneOffActions();
                    });
                }
            }

            function renderLaunchConfigActions() {
                if (!launchActionsList) return;
                if (!launchActions || launchActions.length === 0) {
                    launchActionsList.innerHTML = "";
                    if (launchActionsEmpty) launchActionsEmpty.style.display = "block";
                    return;
                }
                if (launchActionsEmpty) launchActionsEmpty.style.display = "none";
                var html = '<div class="list-group">';
                launchActions.forEach(function (a) {
                    var label = (a.trigger_status || "") + " → " + (a.action_type || "");
                    var detail = "";
                    if (a.action_type === "PUSH_TO_SLACK") {
                        detail = (a.config && a.config.channels) ? ("Channels: " + a.config.channels.join(", ")) : "";
                    } else if (a.action_type === "SEND_EMAIL") {
                        detail = (a.config && a.config.emails) ? ("Emails: " + a.config.emails.join(", ")) : "";
                    } else if (a.action_type === "WRITE_LOG") {
                        detail = (a.config && a.config.level) ? ("Level: " + a.config.level) : "";
                    }
                    if (a.config && a.config.include_ai_csv) {
                        detail = detail ? (detail + " · AI CSV") : "AI CSV";
                    }
                    html += '<div class="list-group-item">';
                    html += '<div class="fw-semibold">' + label + '</div>';
                    if (detail) html += '<div class="text-muted small">' + detail + '</div>';
                    html += '</div>';
                });
                html += "</div>";
                launchActionsList.innerHTML = html;
            }

            function showActionFields(kind) {
                if (actionSlackFields) actionSlackFields.style.display = (kind === "PUSH_TO_SLACK") ? "block" : "none";
                if (actionEmailFields) actionEmailFields.style.display = (kind === "SEND_EMAIL") ? "block" : "none";
                if (actionLogFields) actionLogFields.style.display = (kind === "WRITE_LOG") ? "block" : "none";
            }

            function openActionModal() {
                if (!actionModal) return;
                if (scopeKind !== "start") {
                    var cfgId = getFixedLaunchConfigId();
                    if (!cfgId) return;
                }

                captureActionParentScroll();
                if (actionError) {
                    actionError.style.display = "none";
                    actionError.textContent = "";
                }
                if (actionType) showActionFields(actionType.value);

                if (window.bootstrap && window.bootstrap.Modal) {
                    window.bootstrap.Modal.getOrCreateInstance(actionModal).show();
                } else if (window.jQuery && window.jQuery.fn && window.jQuery.fn.modal) {
                    window.jQuery(actionModal).modal("show");
                } else {
                    actionModal.classList.add("in");
                    actionModal.style.display = "block";
                }
            }

            function closeActionModal() {
                if (!actionModal) return;
                if (window.bootstrap && window.bootstrap.Modal) {
                    window.bootstrap.Modal.getInstance(actionModal)?.hide();
                } else if (window.jQuery && window.jQuery.fn && window.jQuery.fn.modal) {
                    window.jQuery(actionModal).modal("hide");
                } else {
                    actionModal.classList.remove("in");
                    actionModal.style.display = "none";
                }
            }

            if (window.jQuery && actionModal) {
                var $ = window.jQuery;
                $(actionModal).off("hidden.bs.modal.aistActionRestore").on("hidden.bs.modal.aistActionRestore", function () {
                    if (!actionParentModal) return;
                    document.body.classList.add("modal-open");
                    if (!$(".modal-backdrop").length) {
                        $("<div class='modal-backdrop fade show'></div>").appendTo(document.body);
                    }
                    try {
                        $(actionParentModal).modal("handleUpdate");
                    } catch (e) {
                    }
                    restoreActionParentScroll();
                });
            }

            function buildActionUrl(projectId, configId) {
                return actionUrlTpl.replace("/0/launch-configs/0/", "/" + String(projectId) + "/launch-configs/" + String(configId) + "/");
            }

            if (actionType) {
                actionType.addEventListener("change", function () {
                    showActionFields(actionType.value);
                });
            }

            if (btnOpenAction) {
                btnOpenAction.addEventListener("click", function () {
                    openActionModal();
                });
            }

            if (btnSaveAction) {
                btnSaveAction.addEventListener("click", async function () {
                    var projectId = getProjectId();
                    var configId = getFixedLaunchConfigId();
                    if (!projectId) return;
                    if (scopeKind !== "start" && !configId) return;

                    var payload = {
                        trigger_status: actionTrigger ? actionTrigger.value : "",
                        action_type: actionType ? actionType.value : "",
                        config: {},
                        secret_config: {},
                    };

                    var title = actionTitle ? actionTitle.value.trim() : "";
                    var description = actionDescription ? actionDescription.value.trim() : "";
                    var includeAiCsv = actionIncludeAiCsv ? !!actionIncludeAiCsv.checked : false;

                    if (payload.action_type === "PUSH_TO_SLACK") {
                        payload.config.channels = normalizeList(actionSlackChannels ? actionSlackChannels.value : "");
                        payload.config.title = title;
                        payload.config.description = description;
                        payload.config.include_ai_csv = includeAiCsv;
                        var token = actionSlackToken ? actionSlackToken.value.trim() : "";
                        if (token) payload.secret_config.slack_token = token;
                    } else if (payload.action_type === "SEND_EMAIL") {
                        payload.config.emails = normalizeList(actionEmails ? actionEmails.value : "");
                        payload.config.title = title;
                        payload.config.description = description;
                        payload.config.include_ai_csv = includeAiCsv;
                    } else if (payload.action_type === "WRITE_LOG") {
                        payload.config.level = actionLogLevel ? actionLogLevel.value : "INFO";
                        payload.config.description = description;
                        payload.config.include_ai_csv = includeAiCsv;
                    }

                    if (payload.action_type === "PUSH_TO_SLACK" && (!payload.config.channels || payload.config.channels.length === 0)) {
                        if (actionError) {
                            actionError.textContent = "Slack channels are required.";
                            actionError.style.display = "block";
                        }
                        return;
                    }
                    if (payload.action_type === "SEND_EMAIL" && (!payload.config.emails || payload.config.emails.length === 0)) {
                        if (actionError) {
                            actionError.textContent = "Emails are required.";
                            actionError.style.display = "block";
                        }
                        return;
                    }

                    if (scopeKind === "start") {
                        payload.id = payload.id || (String(Date.now()) + "-" + Math.floor(Math.random() * 10000));
                        oneOffActions.push(payload);
                        persistOneOffActions();
                        renderOneOffActions();
                        closeActionModal();
                        return;
                    }

                    try {
                        var resp = await fetch(buildActionUrl(projectId, configId), {
                            method: "POST",
                            credentials: "same-origin",
                            headers: Object.assign({"Content-Type": "application/json"}, {
                                "X-CSRFToken": getCSRFToken(form),
                            }),
                            body: JSON.stringify(payload),
                        });
                        var data = await resp.json().catch(function () { return {}; });
                        if (!resp.ok) {
                            var msg = data && (data.detail || data.error) ? (data.detail || data.error) : "Failed to save action.";
                            if (actionError) {
                                actionError.textContent = msg;
                                actionError.style.display = "block";
                            }
                            return;
                        }
                        if (data && data.id) {
                            launchActions.push(data);
                            renderLaunchConfigActions();
                        }
                        closeActionModal();
                    } catch (ex) {
                        if (actionError) {
                            actionError.textContent = String(ex);
                            actionError.style.display = "block";
                        }
                    }
                });
            }

            var selTime = qsNameEnds(form, 'select', 'time_class_level');
            var selVersion = qsNameEnds(form, 'select', 'project_version');
            var btnStart = form.querySelector('#btn-start');
            var langsWrap = scopeRoot.querySelector("#languages-group");

            var DEFAULT_EMPTY_LABEL = "Use default (latest on default branch)";
            var metaUrlTemplate = "{% url 'aist:project_meta' pk=0 %}";
            var defaultsUrl = "{% url 'aist:default_analyzers' %}";
            var createUrlTpl = "{% url 'aist:project_version_create' project_id=0 %}";
            var actionUrlTpl = "{% url 'aist_api:project_launch_config_action_list_create' project_id=0 config_id=0 %}";


            function getSelectValue(el) {
                if (!el) return "";

                var v = "";

                if (isSelectpickerApplied(el) && window.jQuery) {
                    try {
                        v = window.jQuery(el).selectpicker('val') || "";
                    } catch (e) {
                    }
                }

                if (!v) {
                    v = el.value || "";
                }

                if ((!v || v === "") && el.tagName === "SELECT" && typeof el.selectedIndex === "number") {
                    if (el.selectedIndex > 0) {
                        var opt = el.options[el.selectedIndex];
                        if (opt && opt.value) {
                            v = opt.value;
                        }
                    }
                }

                return v || "";
            }

            function validateVersionRequired() {
                if (!btnStart) return;

                var versionVal = getSelectValue(selVersion);
                var projectVal = selProject ? getSelectValue(selProject) : getFixedProjectId();

                var hasVersion = !!versionVal;
                var hasProject = !!projectVal;

                var canStart = hasProject && hasVersion;

                btnStart.disabled = !canStart;
                btnStart.title = canStart ? "" : "Choose project and version";
            }

            function languageCheckboxes() {
                return langsWrap ? langsWrap.querySelectorAll('input[type="checkbox"][name$="languages"]') : [];
            }


            function setLanguages(supported) {
                var fixed = {};
                if (supported && supported.length) for (var i = 0; i < supported.length; i++) fixed[supported[i]] = true;
                var boxes = languageCheckboxes();
                for (var j = 0; j < boxes.length; j++) {
                    var cb = boxes[j];
                    var isFixed = !!fixed[cb.value];
                    cb.classList.add("form-check-input");
                    var wrap = cb.closest ? cb.closest(".form-check") : null;
                    var lbl = wrap ? wrap.querySelector(".form-check-label") : null;
                    if (isFixed) {
                        cb.checked = true;
                        cb.disabled = true;
                        if (lbl) lbl.classList.add("text-muted");
                    } else {
                        cb.disabled = false;
                        cb.checked = false;
                        if (lbl) lbl.classList.remove("text-muted");
                    }
                }
            }

            function rebuildProjectVersionSelect(versionsRaw, projectId) {
                if (!selVersion) return;
                selVersion.required = true;

                if (document.activeElement === selVersion) {
                    try {
                        document.activeElement.blur();
                    } catch (e) {
                    }
                }

                var list = normalizeVersions(versionsRaw);
                var usingPlugin = isSelectpickerApplied(selVersion);
                var $ = window.jQuery;

                if (usingPlugin) {
                    try {
                        $(selVersion).selectpicker("destroy");
                    } catch (e) {
                    }

                    while (selVersion.options.length) selVersion.remove(0);
                    selVersion.setAttribute("title", DEFAULT_EMPTY_LABEL);
                    selVersion.add(new Option(DEFAULT_EMPTY_LABEL, ""));
                    for (var i = 0; i < list.length; i++) {
                        selVersion.add(new Option(prettifyLabel(list[i].label, projectId), list[i].id));
                    }

                    var disabled = (list.length === 0);
                    selVersion.disabled = disabled;

                    $(selVersion).selectpicker();
                    $(selVersion)
                        .prop("disabled", disabled)
                        .selectpicker("render")
                        .selectpicker("refresh")
                        .selectpicker("val", "");

                    var $wrap = $(selVersion).closest(".bootstrap-select");
                    if ($wrap.length) {
                        $wrap.toggleClass("disabled", disabled);
                        var $btn = $wrap.find("button");
                        if ($btn.length) {
                            $btn.prop("disabled", disabled).blur();
                        }
                    }
                } else {
                    selVersion.innerHTML = "";
                    selVersion.add(new Option(DEFAULT_EMPTY_LABEL, ""));
                    for (var k = 0; k < list.length; k++) {
                        selVersion.add(new Option(prettifyLabel(list[k].label, projectId), list[k].id));
                    }
                    selVersion.disabled = (list.length === 0);
                    setTimeout(function () {
                        try {
                            selVersion.blur();
                        } catch (e) {
                        }
                    }, 0);
                }

                var fs = selVersion.closest ? selVersion.closest("fieldset") : null;
                if (fs && fs.hasAttribute("disabled")) fs.removeAttribute("disabled");

                if (list.length > 0) {
                    var firstId = String(list[0].id);
                    if (isSelectpickerApplied(selVersion)) {
                        try {
                            window.jQuery(selVersion).selectpicker('val', firstId).selectpicker('render').selectpicker('refresh');
                        } catch (e) {
                        }
                    } else {
                        selVersion.value = firstId;
                    }
                } else {

                    if (isSelectpickerApplied(selVersion)) {
                        try {
                            window.jQuery(selVersion).selectpicker('val', '').selectpicker('render').selectpicker('refresh');
                        } catch (e) {
                        }
                    } else {
                        selVersion.value = '';
                    }
                }

                validateVersionRequired();
            }

            function fetchProjectMeta(projectId, done) {
                if (!projectId) {
                    setLanguages([]);
                    rebuildProjectVersionSelect([], projectId);
                    if (done) done();
                    return;
                }
                var url = metaUrlTemplate.replace("/0/", "/" + String(projectId) + "/");
                fetch(url, {credentials: "same-origin"})
                    .then(function (r) {
                        if (!r.ok) return r.text().then(function () {
                            throw new Error("HTTP " + r.status);
                        });
                        return r.json();
                    })
                    .then(function (data) {
                        setLanguages(data && data.supported_languages ? data.supported_languages : []);
                        rebuildProjectVersionSelect(data && data.versions ? data.versions : [], projectId);
                        if (done) done();
                    })
                    .catch(function () {
                        setLanguages([]);
                        rebuildProjectVersionSelect([], projectId);
                        if (done) done();
                    });
            }

            function collectAndRefreshAnalyzers() {
                if (!defaultsUrl) return Promise.resolve();
                var fd = new FormData();
                fd.append("project", getProjectId());
                fd.append("time_class_level", selTime ? selTime.value : "");
                var boxes = languageCheckboxes();
                for (var i = 0; i < boxes.length; i++) if (boxes[i].checked) fd.append("languages", boxes[i].value);

                var csrf = getCSRFToken(form);

                return fetch(defaultsUrl, {
                    method: "POST",
                    body: fd,
                    credentials: "same-origin",
                    headers: {"X-CSRFToken": getCSRFToken(form)}
                })
                    .then(function (r) {
                        return r.json();
                    })
                    .then(function (data) {
                        var sig = form.querySelector('input[name$="selection_signature"]');
                        if (sig && data && data.signature) sig.value = data.signature;

                        var wanted = {};
                        if (data && data.defaults && data.defaults.length) {
                            for (var j = 0; j < data.defaults.length; j++) wanted[data.defaults[j]] = true;
                        }
                        var analyzerBoxes = form.querySelectorAll('input[type="checkbox"][name$="analyzers"]');
                        for (var k = 0; k < analyzerBoxes.length; k++) {
                            analyzerBoxes[k].checked = !!wanted[analyzerBoxes[k].value];
                        }
                    })
                    .catch(function () {
                    });
            }

            function onProjectChanged() {
                var pid = getProjectId();
                fetchProjectMeta(pid, function () {
                    collectAndRefreshAnalyzers();
                });
                updateActionButtonState();
            }

            // Allow projects.html to trigger reload after it sets data-aist-project-id
            window.__AIST_REFRESH_PIPELINE_SCOPE__ = function () {
                onProjectChanged();
                updateCreateButtonState();
                updateActionButtonState();

                // Ensure AI block visibility is synced with current mode in this scope
                try {
                    if (typeof aiToggleAutoUI === "function") aiToggleAutoUI();
                    if (typeof aiGetMode === "function" && aiGetMode() === "AUTO_DEFAULT") {
                        aiLoadEffectiveFilter();
                    }
                } catch (e) {
                }
            };

            window.__AIST_SET_LAUNCH_CONFIG_ID__ = function (cfgId) {
                if (!scopeRoot) return;
                scopeRoot.setAttribute("data-aist-launch-config-id", String(cfgId || ""));
                updateActionButtonState();
            };


            if (selProject) {
                selProject.addEventListener("change", onProjectChanged);
                if (hasSelectpicker()) {
                    try {
                        window.jQuery(selProject).off("changed.bs.select.aist").on("changed.bs.select.aist", onProjectChanged);
                    } catch (e) {
                    }
                }
            }
            if (selTime) {
                selTime.addEventListener("change", collectAndRefreshAnalyzers);
                if (hasSelectpicker()) {
                    try {
                        window.jQuery(selTime).off("changed.bs.select.aist").on("changed.bs.select.aist", collectAndRefreshAnalyzers);
                    } catch (e) {
                    }
                }
            }
            var boxes = languageCheckboxes();
            for (var q = 0; q < boxes.length; q++) boxes[q].addEventListener("change", collectAndRefreshAnalyzers);

            var initialPid = getProjectId();
            if (initialPid) {
                fetchProjectMeta(initialPid, function () {
                    collectAndRefreshAnalyzers();
                });
            } else {
                setLanguages([]);
                rebuildProjectVersionSelect([], "");
            }
            updateActionButtonState();
            renderOneOffActions();
            renderLaunchConfigActions();

            var parentModal = scopeRoot.closest ? scopeRoot.closest(".modal") : null;
            // create-version modal is rendered globally (outside any parent modal), so always search in document
            var modalContainer = document;

            var btnOpenCreate = scopeRoot.querySelector("#btn-open-create-version");
            var btnSubmitCreate = modalContainer.querySelector("#btn-submit-create-version");
            var modalEl = modalContainer.querySelector("#modalCreateVersion");
            var createBody = modalContainer.querySelector("#create-version-body");

            function getParentScrollContainer() {
                if (!parentModal) return null;
                if (parentModal.querySelector(".modal-dialog-scrollable")) {
                    var body = parentModal.querySelector(".modal-body");
                    return body || parentModal;
                }
                return parentModal;
            }

            var parentScrollContainer = getParentScrollContainer();
            var parentScrollTop = 0;

            function captureParentScroll() {
                if (parentScrollContainer) parentScrollTop = parentScrollContainer.scrollTop || 0;
            }

            function restoreParentScroll() {
                if (!parentScrollContainer) return;
                parentScrollContainer.style.overflowY = "auto";
                parentScrollContainer.scrollTop = parentScrollTop || 0;
            }

            var bsModal = {
                show: function () {
                    if (window.jQuery && modalEl) window.jQuery(modalEl).modal("show");
                },
                hide: function () {
                    if (window.jQuery && modalEl) window.jQuery(modalEl).modal("hide");
                }
            };

            function isParentModalOpen() {
                if (!window.jQuery || !parentModal) return false;
                var $pm = window.jQuery(parentModal);
                return $pm.hasClass("show") || $pm.hasClass("in");
            }
            // --- Return parent modal + restore scroll after Create Version modal closes ---
            if (window.jQuery && modalEl && parentModal) {
                var $ = window.jQuery;

                // Важно: обработчик должен быть один (off/on)
                $(modalEl).off("hidden.bs.modal.aistReturnParent").on("hidden.bs.modal.aistReturnParent", function () {
                    // Показываем родителя обратно
                    $(parentModal).one("shown.bs.modal.aistReturnParentShown", function () {
                        // Bootstrap иногда теряет modal-open при nested сценариях
                        document.body.classList.add("modal-open");

                        // если backdrop исчез — вернем (только если его нет)
                        if (!$(".modal-backdrop").length) {
                            $("<div class='modal-backdrop fade show'></div>").appendTo(document.body);
                        }

                        // пересчитать геометрию модалки (помогает вернуть скролл)
                        try {
                            $(parentModal).modal("handleUpdate");
                        } catch (e) {
                        }

                        // восстановить overflow/scroll только когда родитель УЖЕ shown
                        restoreParentScroll();
                    });

                    $(parentModal).modal("show");
                });
            }


            function updateCreateButtonState() {
                if (!btnOpenCreate) return;
                btnOpenCreate.disabled = !getProjectId();
            }

            function initProjectVersionForm(root) {
                var typeSel = root.querySelector('select[name="version_type"]');
                var grpText = root.querySelector('#grp_version_text');
                var grpFile = root.querySelector('#grp_version_file');
                var inpText = root.querySelector('input[name="version"]');
                var inpFile = root.querySelector('input[type="file"][name="source_archive"]');
                var desc = root.querySelector('textarea[name="description"]');
                var meta = root.querySelector('textarea[name="metadata"]');

                if (typeSel) {
                    typeSel.classList.add('selectpicker');
                    typeSel.setAttribute('data-container', 'body');
                    typeSel.setAttribute('data-live-search', 'false');
                    typeSel.style.width = '100%';
                    if (hasSelectpicker()) {
                        try {
                            window.jQuery(typeSel).selectpicker('render');
                        } catch (e) {
                        }
                    }
                }
                if (inpText) inpText.classList.add('form-control');
                if (inpFile) inpFile.classList.add('form-control');
                if (desc) {
                    desc.classList.add('form-control');
                    desc.rows = desc.rows || 2;
                }
                if (meta) {
                    meta.classList.add('form-control');
                    meta.rows = meta.rows || 6;
                }

                function applyVisibility() {
                    var t = typeSel ? String(typeSel.value || '') : 'GIT_HASH';
                    var isFile = (t === 'FILE_HASH');

                    if (grpFile) grpFile.style.display = isFile ? '' : 'none';

                    if (inpText) inpText.required = !isFile;
                    if (inpFile) inpFile.required = isFile;
                }

                // --- progress helpers for hashing ---
                function setFileProgress(visible, text) {
                    var box = root.querySelector('#file-progress');
                    var lbl = root.querySelector('#file-progress-label');
                    if (box) box.style.display = visible ? '' : 'none';
                    if (lbl && text) lbl.textContent = text;
                }

                async function computeSHA256(file, onProgress) {
                    const chunkSize = 1024 * 1024 * 2; // 2MB
                    const reader = file.stream().getReader();
                    const chunksData = [];
                    let loaded = 0;
                    while (true) {
                        const {done, value} = await reader.read();
                        if (done) break;
                        chunksData.push(value);
                        loaded += value.byteLength;
                        if (onProgress && file.size) {
                            onProgress(Math.min(100, Math.floor(loaded * 100 / file.size)));
                        }
                    }
                    const all = new Blob(chunksData);
                    const buf = await all.arrayBuffer();
                    const hash = await crypto.subtle.digest('SHA-256', buf);
                    const hex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
                    return hex;
                }

                if (inpFile) {
                    inpFile.addEventListener('change', async function () {
                        if (!inpFile.files || !inpFile.files[0]) return;
                        var t = typeSel ? String(typeSel.value || '') : 'GIT_HASH';
                        var isFile = (t === 'FILE_HASH');
                        if (!isFile) return;
                        if (inpText && inpText.value.trim()) return;
                        try {
                            setFileProgress(true, 'Computing hash…');
                            const hex = await computeSHA256(inpFile.files[0], function (pct) {
                                setFileProgress(true, 'Computing hash… ' + pct + '%');
                            });
                            if (inpText && !inpText.value.trim()) {
                                inpText.value = hex;
                            }
                            setFileProgress(false, '');
                        } catch (e) {
                            setFileProgress(true, 'Hash failed, will compute on server…');
                            setTimeout(function () {
                                setFileProgress(false, '');
                            }, 1500);
                        }
                    });
                }

                if (typeSel) {
                    typeSel.addEventListener('change', applyVisibility);
                    applyVisibility();
                }
            }


            function loadCreateForm() {
                var pid = getProjectId();
                if (!pid) {
                    createBody.innerHTML = '<div class="alert alert-warning">Select a project first.</div>';
                    return;
                }
                var url = createUrlTpl.replace("/0/", "/" + pid + "/");
                createBody.innerHTML = '<div class="text-center text-muted py-3"><div class="spinner-border"></div> Loading…</div>';
                fetch(url, {credentials: "same-origin"})
                    .then(r => r.text())
                    .then(html => {
                        createBody.innerHTML = html;
                        initProjectVersionForm(createBody);
                    })
                    .catch(() => {
                        createBody.innerHTML = '<div class="alert alert-danger">Failed to load form.</div>';
                    });
            }


            function submitCreateForm() {
                var pid = getProjectId();
                if (!pid) return;
                var url = createUrlTpl.replace("/0/", "/" + pid + "/");
                var formEl = createBody.querySelector("form");
                if (!formEl) return;

                // -------- client-side validation helpers --------
                function markError(el, msg) {
                    if (!el) return;
                    el.classList.add('is-invalid');
                    var fb = el.parentElement ? el.parentElement.querySelector('.invalid-feedback.client') : null;
                    if (!fb) {
                        fb = document.createElement('div');
                        fb.className = 'invalid-feedback client d-block';
                        if (el.parentElement) el.parentElement.appendChild(fb);
                    }
                    fb.textContent = msg;
                }

                function clearClientErrors(root) {
                    root.querySelectorAll('.is-invalid').forEach(function (n) {
                        n.classList.remove('is-invalid');
                    });
                    root.querySelectorAll('.invalid-feedback.client').forEach(function (n) {
                        n.remove();
                    });
                }

                function collectExistingVersionsForSelectedProject() {
                    var ids = [];
                    if (!selVersion) return ids;
                    for (var i = 0; i < selVersion.options.length; i++) {
                        var opt = selVersion.options[i];
                        if (!opt.value) continue;
                        var text = opt.textContent || '';
                        ids.push(text.trim());
                    }
                    return ids;
                }

                function toggleSubmitBusy(busy) {
                    if (!btnSubmitCreate) return;
                    btnSubmitCreate.disabled = !!busy;
                    btnSubmitCreate.innerHTML = busy
                        ? '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...'
                        : 'Create';
                }

                clearClientErrors(createBody);

                var typeSel = formEl.querySelector('select[name="version_type"]');
                var inpText = formEl.querySelector('input[name="version"]');
                var inpFile = formEl.querySelector('input[type="file"][name="source_archive"]');

                var type = typeSel ? String(typeSel.value || '') : 'GIT_HASH';
                var isFile = (type === 'FILE_HASH');
                var version = (inpText && inpText.value) ? inpText.value.trim() : '';

                if (!isFile && !version) {
                    markError(inpText, 'Version is required for GIT_HASH.');
                    return;
                }
                if (isFile && (!inpFile || !inpFile.files || !inpFile.files[0])) {
                    markError(inpFile, 'Archive is required for FILE_HASH.');
                    return;
                }

                var existing = collectExistingVersionsForSelectedProject();
                if (version && existing.indexOf(version) !== -1) {
                    markError(inpText, 'This version already exists for the selected project.');
                    return;
                }

                var fd = new FormData(formEl);
                var csrf = formEl.querySelector('input[name="csrfmiddlewaretoken"]');
                if (csrf) fd.append("csrfmiddlewaretoken", csrf.value);

                toggleSubmitBusy(true);
                fetch(url, {
                    method: "POST",
                    credentials: "same-origin",
                    body: fd
                })
                    .then(function (r) {
                        return r.json();
                    })
                    .then(function (data) {
                        if (data.ok) {
                            var metaUrl = metaUrlTemplate.replace("/0/", "/" + pid + "/");
                            fetch(metaUrl, {credentials: "same-origin"})
                                .then(function (r) {
                                    return r.json();
                                })
                                .then(function (meta) {
                                    if (meta && meta.versions && selVersion) {

                                        rebuildProjectVersionSelect(meta.versions, pid);


                                        var newId = null;
                                        if (data) {
                                            if (data.version && data.version.id != null) newId = String(data.version.id);
                                            else if (data.project_version && data.project_version.id != null) newId = String(data.project_version.id);
                                            else if (data.id != null) newId = String(data.id);
                                        }

                                        if (newId) {
                                            if (isSelectpickerApplied(selVersion) && window.jQuery) {
                                                try {
                                                    window.jQuery(selVersion).selectpicker('val', newId).selectpicker('render').selectpicker('refresh');
                                                } catch (e) {
                                                }
                                            } else {
                                                selVersion.value = newId;
                                            }
                                        }

                                        try {
                                            selVersion.dispatchEvent(new Event('change', {bubbles: true}));
                                        } catch (e) {
                                            var evt = document.createEvent('HTMLEvents');
                                            evt.initEvent('change', true, false);
                                            selVersion.dispatchEvent(evt);
                                        }
                                    }

                                })
                                .finally(function () {
                                    toggleSubmitBusy(false);
                                    bsModal.hide();
                                });
                        } else if (data.html) {
                            createBody.innerHTML = data.html;
                            initProjectVersionForm(createBody);
                            toggleSubmitBusy(false);
                        } else {
                            createBody.innerHTML = '<div class="alert alert-danger">Error while saving version.</div>';
                            toggleSubmitBusy(false);
                        }
                    })
                    .catch(function () {
                        createBody.innerHTML = '<div class="alert alert-danger">Error while saving version.</div>';
                        toggleSubmitBusy(false);
                    });
            }

            if (selVersion) {
                selVersion.addEventListener('change', validateVersionRequired);
                if (hasSelectpicker()) {
                    try {
                        window.jQuery(selVersion).off('changed.bs.select.aist-ver').on('changed.bs.select.aist-ver', validateVersionRequired);
                    } catch (e) {
                    }
                }
            }

            validateVersionRequired();

            if (btnOpenCreate) {
                btnOpenCreate.addEventListener("click", function () {
                    captureParentScroll();

                    loadCreateForm();

                    // If we're inside a parent modal (projects.html preset modal), do NOT stack modals in BS4.
                    if (window.jQuery && parentModal && isParentModalOpen()) {
                        // hide parent first
                        window.jQuery(parentModal).one("hidden.bs.modal.aistSwitch", function () {
                            bsModal.show();
                        });
                        window.jQuery(parentModal).modal("hide");
                    } else {
                        // start.html / non-modal context
                        bsModal.show();
                    }
                });
            }

            if (btnSubmitCreate) {
                btnSubmitCreate.addEventListener("click", submitCreateForm);
            }

            if (selProject) {
                selProject.addEventListener("change", function () {
                    updateCreateButtonState();
                    validateVersionRequired();
                });
                updateCreateButtonState();
            }

            if (aiModeRadios.length) {
                for (var i = 0; i < aiModeRadios.length; i++) {
                    aiModeRadios[i].addEventListener("change", updateAiFilterVisibility);
                }
                updateAiFilterVisibility();
            }

        }

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", main);
        } else {
            main();
        }
    })();
</script>
